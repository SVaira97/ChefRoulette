<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chef Roulette — Beta</title>

  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FG1PK6CJ88"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-FG1PK6CJ88');

    function track(eventName, params = {}) {
      if (typeof gtag === "function") gtag("event", eventName, params);
    }
  </script>

  <style>
    :root {
      /* Branding */
      --bg: #F67919;      /* Harvest Orange */
      --accent: #AF4D03;  /* Autumn Ember */
      --accent2: #FF9A4C; /* Sandy Brown */
      --text: #FFFFFF;
      --ink: #000000;

      /* UI */
      --card: rgba(255,255,255,0.12);
      --border: rgba(0,0,0,0.22);
      --border-strong: rgba(0,0,0,0.32);
      --shadow: 0 14px 40px rgba(0,0,0,0.25);
      --radius: 18px;
      --focus: rgba(255,154,76,0.25);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
      background:
        radial-gradient(900px 540px at 10% 15%, rgba(255,154,76,0.55), transparent 60%),
        radial-gradient(900px 540px at 90% 30%, rgba(175,77,3,0.45), transparent 60%),
        var(--bg);
    }

    .container {
      width: 100%;
      max-width: 920px;
      display: grid;
      gap: 16px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      padding: 18px 18px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .brand {
      display: flex;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }

    .logo {
      margin: 0;
      font-weight: 900;
      letter-spacing: -0.04em;
      font-size: clamp(26px, 4vw, 40px);
      line-height: 1.05;
      text-transform: uppercase;
    }

    .beta {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.30);
      background: rgba(0,0,0,0.12);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      white-space: nowrap;
    }

    .tagline {
      margin: 6px 0 0;
      width: 100%;
      line-height: 1.45;
      font-size: 14px;
      color: rgba(255,255,255,0.92);
    }

    .card {
      padding: 18px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .muted { color: rgba(255,255,255,0.86); }
    .small { font-size: 13px; line-height: 1.5; }

    /* Filtros */
    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      margin-top: 10px;
    }

    .field { display: grid; gap: 6px; }

    .label {
      font-size: 12px;
      font-weight: 900;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.92);
    }

    select {
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.30);
      background: rgba(255,255,255,0.92);
      color: rgba(0,0,0,0.88);
      font-weight: 700;
      font-size: 14px;
      outline: none;
    }

    select:focus {
      border-color: rgba(0,0,0,0.45);
      box-shadow: 0 0 0 3px var(--focus);
    }

    button, a.btn {
      appearance: none;
      border: 1px solid var(--border-strong);
      background: rgba(255,255,255,0.10);
      color: var(--text);
      padding: 11px 14px;
      border-radius: 14px;
      cursor: pointer;
      text-decoration: none;
      font-weight: 900;
      font-size: 14px;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, box-shadow 120ms ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      white-space: nowrap;
    }

    button:hover, a.btn:hover {
      transform: translateY(-1px);
      background: rgba(255,255,255,0.14);
      border-color: rgba(0,0,0,0.45);
      box-shadow: 0 10px 22px rgba(0,0,0,0.16);
    }

    button.primary {
      background: linear-gradient(180deg, rgba(175,77,3,1), rgba(175,77,3,0.82));
      border-color: rgba(0,0,0,0.45);
    }

    button.primary:hover {
      background: linear-gradient(180deg, rgba(175,77,3,1), rgba(175,77,3,0.88));
    }

    button.ghost {
      background: rgba(0,0,0,0.10);
      border-color: rgba(0,0,0,0.30);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .roulette {
      display: grid;
      gap: 12px;
    }

    .stage {
      border: 1px dashed rgba(0,0,0,0.30);
      border-radius: 16px;
      padding: 16px;
      background: rgba(255,255,255,0.08);
      min-height: 220px;
      display: grid;
      align-content: center;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    /* Ruleta visual (más llamativa, contraste alto) */
    .wheelWrap {
      display: grid;
      place-items: center;
      gap: 12px;
    }

    .wheelRow {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 16px;
      align-items: center;
      width: 100%;
    }

    .wheelBox {
      position: relative;
      width: 260px;
      height: 260px;
      display: grid;
      place-items: center;
      margin: 0 auto;
    }

    .pointer {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 22px solid rgba(0,0,0,0.70);
      filter: drop-shadow(0 6px 8px rgba(0,0,0,0.18));
      z-index: 3;
    }

    .wheel {
      width: 260px;
      height: 260px;
      border-radius: 50%;
      border: 7px solid rgba(255,255,255,0.95);
      background:
        radial-gradient(circle at 50% 50%, rgba(0,0,0,0.18) 0 22%, transparent 23%),
        conic-gradient(
          #2E86DE 0deg 45deg,
          #27AE60 45deg 90deg,
          #8E44AD 90deg 135deg,
          #E74C3C 135deg 180deg,
          #F1C40F 180deg 225deg,
          #16A085 225deg 270deg,
          #D35400 270deg 315deg,
          #C0392B 315deg 360deg
        );
      box-shadow:
        0 18px 28px rgba(0,0,0,0.22),
        inset 0 0 0 6px rgba(0,0,0,0.18);
      position: relative;
      transform: rotate(0deg);
      transition: transform 2.25s cubic-bezier(.12,.72,.18,1);
    }

    .wheel::after {
      content: "";
      position: absolute;
      inset: 50% auto auto 50%;
      transform: translate(-50%, -50%);
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(0,0,0,0.70);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    }

    /* Puntitos alrededor estilo ruleta (sin imágenes) */
    .wheelDots {
      position: absolute;
      inset: -10px;
      border-radius: 999px;
      pointer-events: none;
      background:
        radial-gradient(circle, rgba(255,255,255,0.95) 2px, transparent 3px) 0 0 / 18px 18px;
      mask: radial-gradient(circle, transparent 62%, #000 63% 100%);
      opacity: 0.95;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,0.14));
    }

    .resultBlock {
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.22);
      background: rgba(255,255,255,0.10);
      min-height: 160px;
      display: grid;
      align-content: center;
    }

    .result-name {
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.02em;
      margin: 0;
      color: var(--text);
    }

    .result-meta {
      margin: 6px 0 0;
      line-height: 1.4;
      color: rgba(255,255,255,0.88);
      font-weight: 700;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .hidden { display: none !important; }

    /* Email */
    .email-form {
      margin-top: 10px;
      padding: 14px;
      border: 1px solid rgba(0,0,0,0.22);
      border-radius: 16px;
      background: rgba(255,255,255,0.10);
    }

    .email-row { display:flex; gap:8px; flex-wrap:wrap; align-items: center; }

    .email-input {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.30);
      font-size: 14px;
      outline: none;
      min-width: 220px;
    }

    .email-input:focus {
      border-color: rgba(0,0,0,0.45);
      box-shadow: 0 0 0 3px var(--focus);
    }

    .thanks {
      margin-top: 10px;
      padding: 14px;
      border: 1px solid rgba(0,0,0,0.22);
      border-radius: 16px;
      background: rgba(255,255,255,0.10);
    }

    .footer-note {
      margin: 0;
      color: rgba(255,255,255,0.88);
      font-size: 12px;
      line-height: 1.5;
      text-align: center;
      opacity: 0.95;
    }

    @media (max-width: 780px) {
      .wheelRow { grid-template-columns: 1fr; }
      .resultBlock { min-height: 120px; }
    }

    @media (max-width: 520px) {
      .actions > * { flex: 1 1 auto; }
      .filters { grid-template-columns: 1fr; }
      .email-row { flex-direction: column; align-items: stretch; }
      .email-input { min-width: auto; width: 100%; }
      .wheelBox { width: 230px; height: 230px; }
      .wheel { width: 230px; height: 230px; }
    }
  </style>
</head>

<body>
  <main class="container">
    <header>
      <div class="brand">
        <h1 class="logo">Chef Roulette</h1>
        <span class="beta">Beta</span>
      </div>

      <div class="pill">Restaurantes: <span id="count">0</span></div>

      <p class="tagline">
        Filtra por tipo o zona, gira y deja que la ruleta elija. Luego actúa: abre Maps, pide delivery o comparte el resultado.
      </p>
    </header>

    <section class="card roulette" id="rouletteCard">
      <h2>Ruleta</h2>

      <div class="filters">
        <div class="field">
          <div class="label">Tipo</div>
          <select id="typeSelect" aria-label="Filtrar por tipo">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Zona</div>
          <select id="zoneSelect" aria-label="Filtrar por zona">
            <option value="">Todas</option>
          </select>
        </div>

        <div class="field">
          <div class="label">&nbsp;</div>
          <button class="ghost" id="clearFiltersBtn" type="button">Limpiar</button>
        </div>
      </div>

      <div class="stage" id="stage">
        <div class="wheelWrap">
          <div class="wheelRow">
            <div class="wheelBox" aria-hidden="true">
              <div class="pointer"></div>
              <div class="wheelDots"></div>
              <div class="wheel" id="wheel"></div>
            </div>

            <div class="resultBlock">
              <div id="emptyState">
                <p class="muted small" style="margin:0;">
                  Elige filtros (si quieres) y pulsa “Girar ruleta”.
                </p>
                <p class="muted small" style="margin:8px 0 0;">
                  Si filtras demasiado y no hay opciones, te lo diremos.
                </p>
              </div>

              <div id="spinningState" class="hidden">
                <p class="muted small" style="margin:0;">Girando…</p>
                <p class="muted small" style="margin:8px 0 0;">Seleccionando una opción.</p>
              </div>

              <div id="resultState" class="hidden">
                <p class="result-name" id="resultName">—</p>
                <p class="result-meta" id="resultMeta">—</p>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="primary" id="spinBtn" type="button">Girar ruleta</button>

            <a class="btn hidden" id="mapsBtn" target="_blank" rel="noopener noreferrer">Ir al restaurante</a>
            <a class="btn hidden" id="deliveryBtn" target="_blank" rel="noopener noreferrer">Pedir delivery</a>

            <button class="hidden" id="copyBtn" type="button">Copiar</button>
            <button class="hidden" id="spinAgainBtn" type="button">Girar otra vez</button>
          </div>
        </div>
      </div>

      <form
        name="early-access"
        method="POST"
        action="/"
        data-netlify="true"
        netlify-honeypot="bot-field"
        class="email-form hidden"
        id="emailForm"
      >
        <input type="hidden" name="form-name" value="early-access" />
        <p class="hidden">
          <label>Si ves esto, no lo completes: <input name="bot-field" /></label>
        </p>

        <p class="small" style="margin: 0 0 8px;">
          ¿Quieres acceso anticipado y actualizaciones de la beta?
        </p>

        <div class="email-row">
          <input class="email-input" type="email" name="email" placeholder="tu@email.com" required />
          <button type="submit" class="primary" id="emailSubmitBtn">Avisadme</button>
        </div>

        <p class="small muted" style="margin: 8px 0 0;">
          No enviamos spam. Solo avisos.
        </p>
      </form>

      <div class="thanks hidden" id="emailThanks">
        <p style="margin:0; font-weight: 900;">Recibido.</p>
        <p class="small muted" style="margin:6px 0 0;">
          Te avisaremos cuando haya novedades.
        </p>
      </div>

      <p class="muted small" id="hint" style="margin: 12px 0 0;">
        Cambios en Airtable se reflejan automáticamente (puede tardar hasta 1 minuto).
      </p>
    </section>

    <p class="footer-note">Chef Roulette (Beta)</p>
  </main>

  <script>
    // Fallback local
    const FALLBACK_RESTAURANTS = [
      { id: "r1", name: "La Mesa Invisible", cuisine: "Mediterránea", zone: "Centro", deliveryUrl: "", mapsUrl: "", image: "" },
      { id: "r2", name: "Sushi Kintsugi", cuisine: "Sushi", zone: "Salamanca", deliveryUrl: "", mapsUrl: "", image: "" },
      { id: "r3", name: "Brasa Norte", cuisine: "Parrilla", zone: "Chamberí", deliveryUrl: "", mapsUrl: "", image: "" },
      { id: "r4", name: "Pasta & Punto", cuisine: "Italiana", zone: "Retiro", deliveryUrl: "", mapsUrl: "", image: "" },
      { id: "r5", name: "Taco Ritmo", cuisine: "Mexicana", zone: "Malasaña", deliveryUrl: "", mapsUrl: "", image: "" }
    ];

    let RESTAURANTS = [...FALLBACK_RESTAURANTS];

    const state = {
      recentPickedIds: [],
      isSpinning: false,
      spinCount: 0,
      filters: { cuisine: "", zone: "" }
    };

    let lastRestaurant = null;

    function mapsUrlFor(r) {
      if (r.mapsUrl && String(r.mapsUrl).trim().length > 0) return r.mapsUrl;
      const q = encodeURIComponent(`${r.name} Madrid`);
      return `https://www.google.com/maps/search/?api=1&query=${q}`;
    }

    function deliveryUrlFor(r) {
      if (r.deliveryUrl && String(r.deliveryUrl).trim().length > 0) return r.deliveryUrl;
      const q = encodeURIComponent(`${r.cuisine} delivery Madrid`);
      return `https://www.google.com/search?q=${q}`;
    }

    function pickRandomAvoidingRecent(list, recentIds, avoidCount = 3) {
      if (!Array.isArray(list) || list.length === 0) return null;
      if (list.length === 1) return list[0];

      const avoidSet = new Set((recentIds || []).slice(-avoidCount));
      let candidate = null;
      let guard = 0;

      do {
        const idx = Math.floor(Math.random() * list.length);
        candidate = list[idx];
        guard += 1;
      } while (candidate && avoidSet.has(candidate.id) && guard < 60);

      return candidate;
    }

    function uniqSorted(values) {
      const s = new Set();
      for (const v of values) {
        const t = String(v || "").trim();
        if (t) s.add(t);
      }
      return Array.from(s).sort((a,b) => a.localeCompare(b, "es"));
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function getFilteredRestaurants() {
      const c = state.filters.cuisine;
      const z = state.filters.zone;

      return RESTAURANTS.filter(r => {
        const okCuisine = !c || String(r.cuisine).trim() === c;
        const okZone = !z || String(r.zone).trim() === z;
        return okCuisine && okZone;
      });
    }

    async function loadRestaurantsFromFunction() {
      try {
        const res = await fetch("/.netlify/functions/restaurants", { cache: "no-store" });
        if (!res.ok) throw new Error("Function error");
        const data = await res.json();

        const list = Array.isArray(data.restaurants) ? data.restaurants : [];
        if (list.length === 0) throw new Error("Empty list");

        RESTAURANTS = list;
        countEl.textContent = String(RESTAURANTS.length);

        buildFilterOptions();
        track("airtable_loaded", { count: RESTAURANTS.length });
      } catch (e) {
        RESTAURANTS = [...FALLBACK_RESTAURANTS];
        countEl.textContent = String(RESTAURANTS.length);
        buildFilterOptions();
        track("airtable_failed");
      }
    }

    // UI bindings
    const countEl = document.getElementById("count");
    const rouletteCard = document.getElementById("rouletteCard");

    const emptyState = document.getElementById("emptyState");
    const spinningState = document.getElementById("spinningState");
    const resultState = document.getElementById("resultState");

    const resultName = document.getElementById("resultName");
    const resultMeta = document.getElementById("resultMeta");

    const spinBtn = document.getElementById("spinBtn");
    const spinAgainBtn = document.getElementById("spinAgainBtn");
    const mapsBtn = document.getElementById("mapsBtn");
    const deliveryBtn = document.getElementById("deliveryBtn");
    const copyBtn = document.getElementById("copyBtn");

    const typeSelect = document.getElementById("typeSelect");
    const zoneSelect = document.getElementById("zoneSelect");
    const clearFiltersBtn = document.getElementById("clearFiltersBtn");

    const wheelEl = document.getElementById("wheel");
    let wheelRotation = 0;

    const emailForm = document.getElementById("emailForm");
    const emailThanks = document.getElementById("emailThanks");
    const emailSubmitBtn = document.getElementById("emailSubmitBtn");

    function setView(view) {
      emptyState.classList.toggle("hidden", view !== "empty");
      spinningState.classList.toggle("hidden", view !== "spinning");
      resultState.classList.toggle("hidden", view !== "result");
      rouletteCard.classList.toggle("is-spinning", view === "spinning");
    }

    function setActionButtons(hasResult) {
      mapsBtn.classList.toggle("hidden", !hasResult);
      deliveryBtn.classList.toggle("hidden", !hasResult);
      copyBtn.classList.toggle("hidden", !hasResult);
      spinAgainBtn.classList.toggle("hidden", !hasResult);
    }

    function setSpinning(isSpinning) {
      state.isSpinning = isSpinning;
      spinBtn.disabled = isSpinning;
      spinAgainBtn.disabled = isSpinning;
      copyBtn.disabled = isSpinning;
      typeSelect.disabled = isSpinning;
      zoneSelect.disabled = isSpinning;
      clearFiltersBtn.disabled = isSpinning;
    }

    function spinWheelVisual() {
      // 5 a 7 vueltas + ángulo aleatorio
      const turns = 360 * (5 + Math.floor(Math.random() * 3));
      const rand = Math.floor(Math.random() * 360);
      wheelRotation = wheelRotation + turns + rand;
      wheelEl.style.transform = `rotate(${wheelRotation}deg)`;
    }

    function showResult(r) {
      lastRestaurant = r;

      track("result_shown", {
        restaurant: r.name,
        cuisine: r.cuisine,
        zone: r.zone
      });

      resultName.textContent = r.name;
      resultMeta.textContent = `${r.cuisine} · ${r.zone}`;

      mapsBtn.href = mapsUrlFor(r);
      deliveryBtn.href = deliveryUrlFor(r);

      setActionButtons(true);
      setView("result");

      emailForm.classList.remove("hidden");
      emailThanks.classList.add("hidden");
    }

    function spin() {
      if (state.isSpinning) return;

      const filtered = getFilteredRestaurants();

      track("spin", {
        filter_cuisine: state.filters.cuisine || "all",
        filter_zone: state.filters.zone || "all",
        pool_size: filtered.length
      });

      setSpinning(true);
      setActionButtons(false);
      setView("spinning");
      spinWheelVisual();

      window.setTimeout(() => {
        const picked = pickRandomAvoidingRecent(filtered, state.recentPickedIds, 3);

        if (!picked) {
          lastRestaurant = null;
          setSpinning(false);
          setActionButtons(false);
          setView("empty");
          emptyState.innerHTML = `
            <p class="muted small" style="margin:0;">
              No hay restaurantes con esos filtros.
            </p>
            <p class="muted small" style="margin:8px 0 0;">
              Prueba a cambiar Tipo/Zona o pulsa “Limpiar”.
            </p>
          `;
          return;
        }

        // restaurar copy por si veníamos de "no hay resultados"
        emptyState.innerHTML = `
          <p class="muted small" style="margin:0;">
            Elige filtros (si quieres) y pulsa “Girar ruleta”.
          </p>
          <p class="muted small" style="margin:8px 0 0;">
            Si filtras demasiado y no hay opciones, te lo diremos.
          </p>
        `;

        state.recentPickedIds.push(picked.id);
        if (state.recentPickedIds.length > 10) state.recentPickedIds.shift();
        state.spinCount += 1;

        showResult(picked);
        setSpinning(false);
      }, 900);
    }

    async function copyCurrentResult() {
      if (!lastRestaurant) return;

      track("copy_click", {
        restaurant: lastRestaurant.name,
        cuisine: lastRestaurant.cuisine,
        zone: lastRestaurant.zone
      });

      const text = `${lastRestaurant.name} (${lastRestaurant.cuisine}) - ${lastRestaurant.zone}`;

      try {
        await navigator.clipboard.writeText(text);
        const old = copyBtn.textContent;
        copyBtn.textContent = "Copiado";
        window.setTimeout(() => (copyBtn.textContent = old), 1200);
      } catch (e) {
        alert(text);
      }
    }

    function encodeFormData(form) {
      const data = new FormData(form);
      const pairs = [];
      for (const [key, value] of data.entries()) {
        pairs.push(encodeURIComponent(key) + "=" + encodeURIComponent(String(value)));
      }
      return pairs.join("&");
    }

    function buildFilterOptions() {
      const cuisines = uniqSorted(RESTAURANTS.map(r => r.cuisine));
      const zones = uniqSorted(RESTAURANTS.map(r => r.zone));

      const currentCuisine = state.filters.cuisine;
      const currentZone = state.filters.zone;

      typeSelect.innerHTML = `<option value="">Todos</option>` + cuisines.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      zoneSelect.innerHTML = `<option value="">Todas</option>` + zones.map(z => `<option value="${escapeHtml(z)}">${escapeHtml(z)}</option>`).join("");

      typeSelect.value = cuisines.includes(currentCuisine) ? currentCuisine : "";
      zoneSelect.value = zones.includes(currentZone) ? currentZone : "";

      state.filters.cuisine = typeSelect.value;
      state.filters.zone = zoneSelect.value;
    }

    // Events
    spinBtn.addEventListener("click", spin);
    spinAgainBtn.addEventListener("click", spin);
    copyBtn.addEventListener("click", copyCurrentResult);

    mapsBtn.addEventListener("click", () => {
      if (!lastRestaurant) return;
      track("maps_click", { restaurant: lastRestaurant.name, cuisine: lastRestaurant.cuisine, zone: lastRestaurant.zone });
    });

    deliveryBtn.addEventListener("click", () => {
      if (!lastRestaurant) return;
      track("delivery_click", { restaurant: lastRestaurant.name, cuisine: lastRestaurant.cuisine, zone: lastRestaurant.zone });
    });

    typeSelect.addEventListener("change", () => {
      state.filters.cuisine = typeSelect.value;
      track("filter_change", { filter: "cuisine", value: state.filters.cuisine || "all" });
    });

    zoneSelect.addEventListener("change", () => {
      state.filters.zone = zoneSelect.value;
      track("filter_change", { filter: "zone", value: state.filters.zone || "all" });
    });

    clearFiltersBtn.addEventListener("click", () => {
      state.filters.cuisine = "";
      state.filters.zone = "";
      typeSelect.value = "";
      zoneSelect.value = "";
      track("filter_clear");
    });

    // Email submit (Netlify forms)
    emailForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      emailSubmitBtn.disabled = true;

      try {
        const body = encodeFormData(emailForm);

        const res = await fetch("/", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });

        if (!res.ok) throw new Error("Form submit failed");

        track("email_submitted");

        emailForm.classList.add("hidden");
        emailThanks.classList.remove("hidden");
        emailForm.reset();
      } catch (err) {
        alert("No se pudo enviar el email. Prueba otra vez.");
      } finally {
        emailSubmitBtn.disabled = false;
      }
    });

    // Init
    countEl.textContent = String(RESTAURANTS.length);
    setView("empty");
    setActionButtons(false);
    buildFilterOptions();
    loadRestaurantsFromFunction();

    window.__chefRoulette = {
      state,
      getRestaurants: () => RESTAURANTS,
      getFilteredRestaurants,
      spin
    };
  </script>
</body>
</html>

